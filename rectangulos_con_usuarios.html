<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>4 piezas – EQUIPO 1 (Colaborativo con usuarios)</title>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* ========================================
       VARIABLES DE DISEÑO
       ======================================== */
    :root {
      --bg: #f7f8fb;
      --grid: rgba(0, 0, 0, .05);
      --piece: #cfecee;
      --stroke: #3a556a;
      --shadow: rgba(0, 0, 0, .08);
    }

    /* ========================================
       ESTILOS BASE
       ======================================== */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
    }

    /* ========================================
       MODAL DE NOMBRE
       ======================================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: white;
      padding: 32px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 400px;
      width: 90%;
    }

    .modal h2 {
      margin: 0 0 8px 0;
      font-size: 24px;
      color: #000;
    }

    .modal p {
      margin: 0 0 24px 0;
      color: #666;
      font-size: 14px;
    }

    .modal input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e6e6e6;
      border-radius: 8px;
      font-size: 16px;
      box-sizing: border-box;
      margin-bottom: 16px;
    }

    .modal input:focus {
      outline: none;
      border-color: #3a556a;
    }

    .modal button {
      width: 100%;
      padding: 12px;
      background: #3a556a;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .modal button:hover {
      background: #2a4050;
    }

    .modal button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* ========================================
       TABLERO CON CUADRÍCULA
       ======================================== */
    .board {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size: 40px 40px;
      background-position: -1px -1px;
    }

    /* ========================================
       BARRA DE HERRAMIENTAS SUPERIOR
       ======================================== */
    .toolbar {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      align-items: center;
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 999px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .06);
      padding: 8px 16px;
      font-size: 14px;
      z-index: 10;
      user-select: none;
      flex-wrap: wrap;
      max-width: 90%;
    }

    .pill {
      padding: 6px 12px;
      border: 1px solid #e6e6e6;
      border-radius: 999px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    .pill:hover {
      background: #f5f5f5;
    }

    .pill.danger {
      color: #dc2626;
      border-color: #fecaca;
    }

    .pill.danger:hover {
      background: #fef2f2;
    }

    .badge {
      font-weight: 600;
      color: #666;
      font-size: 13px;
    }

    .msg {
      padding: 8px 12px;
      border: 1px solid #e6e6e6;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .05);
      font-size: 13px;
    }

    .msg b {
      font-weight: 700;
    }

    .status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status.online {
      background: #22c55e;
    }

    .status.connecting {
      background: #f59e0b;
    }

    /* ========================================
       PANEL DE USUARIOS
       ======================================== */
    .users-panel {
      position: fixed;
      right: 16px;
      top: 80px;
      background: white;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .06);
      max-width: 250px;
      max-height: 400px;
      overflow-y: auto;
    }

    .users-panel h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #666;
    }

    .user-item {
      padding: 8px 12px;
      background: #f7f8fb;
      border-radius: 8px;
      margin-bottom: 6px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .user-item.me {
      background: #cfecee;
      font-weight: 600;
    }

    .user-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #22c55e;
    }

    /* ========================================
       PIEZAS RECTANGULARES MOVIBLES
       ======================================== */
    .piece {
      position: absolute;
      left: 0;
      top: 0;
      width: 180px;
      height: 120px;
      background: var(--piece);
      border: 2px solid var(--stroke);
      border-radius: 0;
      box-shadow: 0 10px 20px var(--shadow);
      cursor: grab;
      touch-action: none;
      user-select: none;
      transition: box-shadow 0.2s;
    }

    .piece:active {
      cursor: grabbing;
      box-shadow: 0 15px 30px rgba(0, 0, 0, .15);
    }

    .handle-rotate {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -24px;
      width: 16px;
      height: 16px;
      border: 2px solid var(--stroke);
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
      cursor: grab;
      touch-action: none;
    }

    /* ========================================
       ETIQUETA DE EQUIPO
       ======================================== */
    .label {
      position: fixed;
      left: 16px;
      bottom: 16px;
      background: #000;
      color: #fff;
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .2);
      letter-spacing: .5px;
    }
  </style>
</head>

<body>
  <!-- ========================================
       MODAL DE ENTRADA
       ======================================== -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <h2>Bienvenido a EQUIPO 1</h2>
      <p>Introduce tu nombre para unirte a la sala colaborativa</p>
      <input type="text" id="nameInput" placeholder="Tu nombre" maxlength="30" />
      <button id="joinButton" disabled>Unirse a la sala</button>
    </div>
  </div>

  <!-- ========================================
       INTERFAZ PRINCIPAL
       ======================================== -->
  
  <div class="toolbar">
    <button id="btnReset" class="pill">Reset ejercicio</button>
    <button id="btnLeave" class="pill danger">Abandonar sala</button>
    <span class="msg">
      <span class="status connecting" id="statusDot"></span>
      <b>Modo colaborativo.</b> <span id="statusText">Conectando...</span>
    </span>
    <span class="badge"><span id="userCount">0</span> usuarios conectados</span>
  </div>

  <div class="users-panel" id="usersPanel">
    <h3>USUARIOS ACTIVOS</h3>
    <div id="usersList"></div>
  </div>

  <div id="board" class="board"></div>
  <div class="label">EQUIPO 1</div>

  <!-- ========================================
       LÓGICA DE LA APLICACIÓN
       ======================================== -->
  <script>
    (function() {
      'use strict';

      // ========================================
      // CONFIGURACIÓN DE SUPABASE
      // ========================================
      
      const SUPABASE_URL = 'https://spvnbssyihyoxptnkjjj.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdm5ic3N5aWh5b3hwdG5rampqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDQ1NDAsImV4cCI6MjA3Njk4MDU0MH0.ERHGsA7jVsQw4gSFRY633wBxr4dhqXSq8-5gtxVqdXs';
      
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // ========================================
      // CONSTANTES Y CONFIGURACIÓN
      // ========================================
      
      const SESSION_ID = 'session_' + Math.random().toString(36).substr(2, 9);
      let MY_USER_NAME = '';
      
      const board = document.getElementById('board');
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      const userCount = document.getElementById('userCount');
      const usersList = document.getElementById('usersList');

      const initialState = [
        { piece_index: 0, left: 120, top: 340, angle: 0 },
        { piece_index: 1, left: 340, top: 340, angle: 0 },
        { piece_index: 2, left: 560, top: 340, angle: 0 },
        { piece_index: 3, left: 780, top: 340, angle: 0 },
      ];

      const pieces = [];
      let isUpdatingFromServer = false;
      let presenceInterval = null;

      // ========================================
      // MODAL DE ENTRADA
      // ========================================

      const modalOverlay = document.getElementById('modalOverlay');
      const nameInput = document.getElementById('nameInput');
      const joinButton = document.getElementById('joinButton');

      nameInput.addEventListener('input', () => {
        joinButton.disabled = nameInput.value.trim().length < 2;
      });

      nameInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !joinButton.disabled) {
          joinButton.click();
        }
      });

      joinButton.addEventListener('click', async () => {
        MY_USER_NAME = nameInput.value.trim();
        modalOverlay.style.display = 'none';
        await init();
      });

      // Auto-focus en el input
      setTimeout(() => nameInput.focus(), 100);

      // ========================================
      // GESTIÓN DE USUARIOS
      // ========================================

      async function registerUser() {
        try {
          const { error } = await supabase
            .from('active_users')
            .insert({
              user_name: MY_USER_NAME,
              session_id: SESSION_ID,
              last_seen: new Date().toISOString()
            });

          if (error) throw error;
        } catch (error) {
          console.error('Error registrando usuario:', error);
        }
      }

      async function updatePresence() {
        try {
          const { error } = await supabase
            .from('active_users')
            .update({ last_seen: new Date().toISOString() })
            .eq('session_id', SESSION_ID);

          if (error) throw error;
        } catch (error) {
          console.error('Error actualizando presencia:', error);
        }
      }

      async function removeUser() {
        try {
          const { error } = await supabase
            .from('active_users')
            .delete()
            .eq('session_id', SESSION_ID);

          if (error) throw error;
        } catch (error) {
          console.error('Error eliminando usuario:', error);
        }
      }

      async function cleanInactiveUsers() {
        try {
          const tenSecondsAgo = new Date(Date.now() - 10000).toISOString();
          const { error } = await supabase
            .from('active_users')
            .delete()
            .lt('last_seen', tenSecondsAgo);

          if (error) throw error;
        } catch (error) {
          console.error('Error limpiando usuarios inactivos:', error);
        }
      }

      async function loadActiveUsers() {
        try {
          const { data, error } = await supabase
            .from('active_users')
            .select('*')
            .order('user_name');

          if (error) throw error;

          userCount.textContent = data.length;
          renderUsersList(data);
        } catch (error) {
          console.error('Error cargando usuarios:', error);
        }
      }

      function renderUsersList(users) {
        usersList.innerHTML = users.map(user => `
          <div class="user-item ${user.session_id === SESSION_ID ? 'me' : ''}">
            <span class="user-dot"></span>
            ${user.user_name}${user.session_id === SESSION_ID ? ' (tú)' : ''}
          </div>
        `).join('');
      }

      function setupUsersSubscription() {
        supabase
          .channel('users-channel')
          .on('postgres_changes',
            { event: '*', schema: 'public', table: 'active_users' },
            () => {
              loadActiveUsers();
            }
          )
          .subscribe();
      }

      // ========================================
      // INICIALIZAR BASE DE DATOS
      // ========================================

      async function initializeDatabase() {
        try {
          const { data, error } = await supabase
            .from('pieces')
            .select('*');

          if (error) throw error;

          if (!data || data.length === 0) {
            const { error: insertError } = await supabase
              .from('pieces')
              .insert(initialState);
            
            if (insertError) throw insertError;
            return initialState;
          }

          return data.sort((a, b) => a.piece_index - b.piece_index);
        } catch (error) {
          console.error('Error inicializando base de datos:', error);
          return initialState;
        }
      }

      // ========================================
      // FUNCIONES AUXILIARES
      // ========================================

      function setRotation(el, deg) {
        el.style.transform = `rotate(${deg}deg)`;
      }

      // ========================================
      // CREACIÓN DE PIEZAS
      // ========================================

      function createPiece(i, state) {
        const p = document.createElement('div');
        p.className = 'piece';
        p.dataset.index = i;
        p.dataset.angle = state.angle || 0;
        p.style.left = state.left + 'px';
        p.style.top = state.top + 'px';
        setRotation(p, +p.dataset.angle);

        const h = document.createElement('div');
        h.className = 'handle-rotate';
        p.appendChild(h);

        board.appendChild(p);

        let dragging = false;
        let startX = 0, startY = 0, startLeft = 0, startTop = 0;
        let lastSyncTime = 0;
        const SYNC_THROTTLE = 50;

        p.addEventListener('pointerdown', (ev) => {
          if (ev.target === h) return;
          dragging = true;
          p.setPointerCapture(ev.pointerId);
          startX = ev.clientX;
          startY = ev.clientY;
          startLeft = parseFloat(p.style.left);
          startTop = parseFloat(p.style.top);
        });

        p.addEventListener('pointermove', (ev) => {
          if (!dragging) return;
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          p.style.left = (startLeft + dx) + 'px';
          p.style.top = (startTop + dy) + 'px';
          
          const now = Date.now();
          if (now - lastSyncTime > SYNC_THROTTLE) {
            lastSyncTime = now;
            syncPiece(i, p);
          }
        });

        p.addEventListener('pointerup', () => {
          if (dragging) {
            dragging = false;
            syncPiece(i, p);
          }
        });

        p.addEventListener('pointercancel', () => {
          dragging = false;
        });

        let rotating = false;
        let baseAngle = 0;
        let startAngle = 0;
        let lastRotateSyncTime = 0;
        const ROTATE_SYNC_THROTTLE = 50;

        const angleFromPointer = (ev) => {
          const rect = p.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          return Math.atan2(ev.clientY - cy, ev.clientX - cx) * 180 / Math.PI;
        };

        h.addEventListener('pointerdown', (ev) => {
          ev.stopPropagation();
          rotating = true;
          h.setPointerCapture(ev.pointerId);
          baseAngle = +p.dataset.angle;
          startAngle = angleFromPointer(ev);
        });

        h.addEventListener('pointermove', (ev) => {
          if (!rotating) return;
          const current = angleFromPointer(ev);
          const diff = current - startAngle;
          const newAng = baseAngle + diff;
          p.dataset.angle = newAng;
          setRotation(p, newAng);
          
          const now = Date.now();
          if (now - lastRotateSyncTime > ROTATE_SYNC_THROTTLE) {
            lastRotateSyncTime = now;
            syncPiece(i, p);
          }
        });

        h.addEventListener('pointerup', () => {
          if (rotating) {
            rotating = false;
            syncPiece(i, p);
          }
        });

        h.addEventListener('pointercancel', () => {
          rotating = false;
        });

        pieces.push(p);
      }

      // ========================================
      // SINCRONIZACIÓN
      // ========================================

      async function syncPiece(index, pieceEl) {
        if (isUpdatingFromServer) return;

        const pieceData = {
          left: parseFloat(pieceEl.style.left),
          top: parseFloat(pieceEl.style.top),
          angle: parseFloat(pieceEl.dataset.angle)
        };

        try {
          const { error } = await supabase
            .from('pieces')
            .update(pieceData)
            .eq('piece_index', index);

          if (error) throw error;
        } catch (error) {
          console.error('Error sincronizando pieza:', error);
        }
      }

      function updatePieceFromServer(i, pieceData) {
        if (pieces[i]) {
          pieces[i].style.transition = 'left 0.1s ease-out, top 0.1s ease-out';
          pieces[i].style.left = pieceData.left + 'px';
          pieces[i].style.top = pieceData.top + 'px';
          pieces[i].dataset.angle = pieceData.angle || 0;
          setRotation(pieces[i], +pieces[i].dataset.angle);
          
          setTimeout(() => {
            pieces[i].style.transition = 'box-shadow 0.2s';
          }, 150);
        }
      }

      function setupRealtimeSubscription() {
        supabase
          .channel('pieces-changes')
          .on('postgres_changes',
            { event: 'UPDATE', schema: 'public', table: 'pieces' },
            (payload) => {
              isUpdatingFromServer = true;
              const piece = payload.new;
              updatePieceFromServer(piece.piece_index, piece);
              setTimeout(() => { isUpdatingFromServer = false; }, 100);
            }
          )
          .subscribe();
      }

      // ========================================
      // INICIALIZACIÓN
      // ========================================

      async function init() {
        try {
          statusDot.className = 'status connecting';
          statusText.textContent = 'Conectando...';

          await registerUser();
          await cleanInactiveUsers();
          await loadActiveUsers();

          const state = await initializeDatabase();

          for (let i = 0; i < 4; i++) {
            createPiece(i, state[i]);
          }

          setupRealtimeSubscription();
          setupUsersSubscription();

          presenceInterval = setInterval(updatePresence, 5000);
          setInterval(cleanInactiveUsers, 10000);

          statusDot.className = 'status online';
          statusText.textContent = 'Todos pueden mover y rotar las piezas en tiempo real.';
        } catch (error) {
          console.error('Error de inicialización:', error);
          statusDot.className = 'status offline';
          statusText.textContent = 'Error de conexión';
        }
      }

      // ========================================
      // BOTONES
      // ========================================

      document.getElementById('btnReset').addEventListener('click', async () => {
        try {
          for (let i = 0; i < 4; i++) {
            const { error } = await supabase
              .from('pieces')
              .update({
                left: initialState[i].left,
                top: initialState[i].top,
                angle: initialState[i].angle
              })
              .eq('piece_index', i);

            if (error) throw error;
          }
        } catch (error) {
          console.error('Error reseteando:', error);
        }
      });

      document.getElementById('btnLeave').addEventListener('click', async () => {
        if (confirm('¿Estás seguro de que quieres abandonar la sala?')) {
          await removeUser();
          if (presenceInterval) clearInterval(presenceInterval);
          window.location.reload();
        }
      });

      window.addEventListener('beforeunload', async () => {
        await removeUser();
      });

    })();
  </script>
</body>
</html>
