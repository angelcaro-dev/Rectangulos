<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>4 piezas – EQUIPO 1 (Colaborativo)</title>
  
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* ========================================
       VARIABLES DE DISEÑO
       ======================================== */
    :root {
      --bg: #f7f8fb;
      --grid: rgba(0, 0, 0, .05);
      --piece: #cfecee;
      --stroke: #3a556a;
      --shadow: rgba(0, 0, 0, .08);
    }

    /* ========================================
       ESTILOS BASE
       ======================================== */
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
    }

    /* ========================================
       TABLERO CON CUADRÍCULA
       ======================================== */
    .board {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(var(--grid) 1px, transparent 1px),
        linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size: 40px 40px;
      background-position: -1px -1px;
    }

    /* ========================================
       BARRA DE HERRAMIENTAS SUPERIOR
       ======================================== */
    .toolbar {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      align-items: center;
      background: #fff;
      border: 1px solid #e6e6e6;
      border-radius: 999px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .06);
      padding: 8px 16px;
      font-size: 14px;
      z-index: 10;
      user-select: none;
      flex-wrap: wrap;
      max-width: 90%;
    }

    .pill {
      padding: 6px 12px;
      border: 1px solid #e6e6e6;
      border-radius: 999px;
      background: #fff;
      cursor: pointer;
      font-size: 13px;
    }

    .pill:hover {
      background: #f5f5f5;
    }

    .badge {
      font-weight: 600;
      color: #666;
      font-size: 13px;
    }

    .msg {
      padding: 8px 12px;
      border: 1px solid #e6e6e6;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .05);
      font-size: 13px;
    }

    .msg b {
      font-weight: 700;
    }

    /* Indicadores de estado */
    .status {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .status.online {
      background: #22c55e;
    }

    .status.connecting {
      background: #f59e0b;
    }

    /* ========================================
       PIEZAS RECTANGULARES MOVIBLES
       ======================================== */
    .piece {
      position: absolute;
      left: 0;
      top: 0;
      width: 180px;
      height: 120px;
      background: var(--piece);
      border: 2px solid var(--stroke);
      border-radius: 0;
      box-shadow: 0 10px 20px var(--shadow);
      cursor: grab;
      touch-action: none;
      user-select: none;
      transition: box-shadow 0.2s;
    }

    .piece:active {
      cursor: grabbing;
      box-shadow: 0 15px 30px rgba(0, 0, 0, .15);
    }

    /* Círculo para rotar las piezas */
    .handle-rotate {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -24px;
      width: 16px;
      height: 16px;
      border: 2px solid var(--stroke);
      border-radius: 50%;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .1);
      cursor: grab;
      touch-action: none;
    }

    /* ========================================
       ETIQUETA DE EQUIPO
       ======================================== */
    .label {
      position: fixed;
      left: 16px;
      bottom: 16px;
      background: #000;
      color: #fff;
      font-weight: 700;
      padding: 10px 14px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .2);
      letter-spacing: .5px;
    }
  </style>
</head>

<body>
  <!-- ========================================
       INTERFAZ DE USUARIO
       ======================================== -->
  
  <!-- Barra de herramientas superior -->
  <div class="toolbar">
    <button id="btnReset" class="pill">Reset ejercicio</button>
    <span class="msg">
      <span class="status connecting" id="statusDot"></span>
      <b>Modo colaborativo.</b> <span id="statusText">Conectando...</span>
    </span>
    <span class="badge">Sala: EQUIPO1 · Sincronización en tiempo real</span>
  </div>

  <!-- Tablero donde se colocan las piezas -->
  <div id="board" class="board"></div>

  <!-- Etiqueta identificativa del equipo -->
  <div class="label">EQUIPO 1</div>

  <!-- ========================================
       LÓGICA DE LA APLICACIÓN
       ======================================== -->
  <script>
    (function() {
      'use strict';

      // ========================================
      // CONFIGURACIÓN DE SUPABASE
      // ========================================
      
      const SUPABASE_URL = 'https://spvnbssyihyoxptnkjjj.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNwdm5ic3N5aWh5b3hwdG5rampqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0MDQ1NDAsImV4cCI6MjA3Njk4MDU0MH0.ERHGsA7jVsQw4gSFRY633wBxr4dhqXSq8-5gtxVqdXs';
      
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // ========================================
      // CONSTANTES Y CONFIGURACIÓN
      // ========================================
      
      // Elementos del DOM
      const board = document.getElementById('board');
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');

      // Posiciones iniciales de las 4 piezas
      const initialState = [
        { piece_index: 0, left: 120, top: 340, angle: 0 },
        { piece_index: 1, left: 340, top: 340, angle: 0 },
        { piece_index: 2, left: 560, top: 340, angle: 0 },
        { piece_index: 3, left: 780, top: 340, angle: 0 },
      ];

      // ========================================
      // VARIABLES DE ESTADO
      // ========================================
      
      const pieces = []; // Array de elementos DOM
      let isUpdatingFromServer = false; // Previene bucles infinitos

      // ========================================
      // FUNCIONES AUXILIARES
      // ========================================

      /**
       * Aplica rotación CSS a un elemento
       */
      function setRotation(el, deg) {
        el.style.transform = `rotate(${deg}deg)`;
      }

      // ========================================
      // INICIALIZAR BASE DE DATOS
      // ========================================

      async function initializeDatabase() {
        try {
          // Verificar si ya hay datos
          const { data, error } = await supabase
            .from('pieces')
            .select('*');

          if (error) throw error;

          // Si no hay datos, insertar los iniciales
          if (!data || data.length === 0) {
            const { error: insertError } = await supabase
              .from('pieces')
              .insert(initialState);
            
            if (insertError) throw insertError;
            
            return initialState;
          }

          return data.sort((a, b) => a.piece_index - b.piece_index);
        } catch (error) {
          console.error('Error inicializando base de datos:', error);
          return initialState;
        }
      }

      // ========================================
      // CREACIÓN DE PIEZAS
      // ========================================

      /**
       * Crea una pieza rectangular interactiva
       */
      function createPiece(i, state) {
        // Crear elemento de la pieza
        const p = document.createElement('div');
        p.className = 'piece';
        p.dataset.index = i;
        p.dataset.angle = state.angle || 0;
        p.style.left = state.left + 'px';
        p.style.top = state.top + 'px';
        setRotation(p, +p.dataset.angle);

        // Crear manejador de rotación (círculo)
        const h = document.createElement('div');
        h.className = 'handle-rotate';
        p.appendChild(h);

        board.appendChild(p);

        // ========================================
        // ARRASTRE DE LA PIEZA
        // ========================================
        
        let dragging = false;
        let startX = 0, startY = 0, startLeft = 0, startTop = 0;

        p.addEventListener('pointerdown', (ev) => {
          if (ev.target === h) return;
          dragging = true;
          p.setPointerCapture(ev.pointerId);
          startX = ev.clientX;
          startY = ev.clientY;
          startLeft = parseFloat(p.style.left);
          startTop = parseFloat(p.style.top);
        });

        p.addEventListener('pointermove', (ev) => {
          if (!dragging) return;
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          p.style.left = (startLeft + dx) + 'px';
          p.style.top = (startTop + dy) + 'px';
        });

        p.addEventListener('pointerup', () => {
          if (dragging) {
            dragging = false;
            syncPiece(i, p);
          }
        });

        p.addEventListener('pointercancel', () => {
          dragging = false;
        });

        // ========================================
        // ROTACIÓN DE LA PIEZA
        // ========================================
        
        let rotating = false;
        let baseAngle = 0;
        let startAngle = 0;

        const angleFromPointer = (ev) => {
          const rect = p.getBoundingClientRect();
          const cx = rect.left + rect.width / 2;
          const cy = rect.top + rect.height / 2;
          return Math.atan2(ev.clientY - cy, ev.clientX - cx) * 180 / Math.PI;
        };

        h.addEventListener('pointerdown', (ev) => {
          ev.stopPropagation();
          rotating = true;
          h.setPointerCapture(ev.pointerId);
          baseAngle = +p.dataset.angle;
          startAngle = angleFromPointer(ev);
        });

        h.addEventListener('pointermove', (ev) => {
          if (!rotating) return;
          const current = angleFromPointer(ev);
          const diff = current - startAngle;
          const newAng = baseAngle + diff;
          p.dataset.angle = newAng;
          setRotation(p, newAng);
        });

        h.addEventListener('pointerup', () => {
          if (rotating) {
            rotating = false;
            syncPiece(i, p);
          }
        });

        h.addEventListener('pointercancel', () => {
          rotating = false;
        });

        pieces.push(p);
      }

      // ========================================
      // SINCRONIZACIÓN CON SUPABASE
      // ========================================

      /**
       * Sincroniza una pieza con la base de datos
       */
      async function syncPiece(index, pieceEl) {
        if (isUpdatingFromServer) return;

        const pieceData = {
          left: parseFloat(pieceEl.style.left),
          top: parseFloat(pieceEl.style.top),
          angle: parseFloat(pieceEl.dataset.angle)
        };

        try {
          const { error } = await supabase
            .from('pieces')
            .update(pieceData)
            .eq('piece_index', index);

          if (error) throw error;
        } catch (error) {
          console.error('Error sincronizando pieza:', error);
        }
      }

      /**
       * Actualiza una pieza desde datos remotos
       */
      function updatePieceFromServer(i, pieceData) {
        if (pieces[i]) {
          pieces[i].style.left = pieceData.left + 'px';
          pieces[i].style.top = pieceData.top + 'px';
          pieces[i].dataset.angle = pieceData.angle || 0;
          setRotation(pieces[i], +pieces[i].dataset.angle);
        }
      }

      // ========================================
      // SUSCRIPCIÓN A CAMBIOS EN TIEMPO REAL
      // ========================================

      supabase
        .channel('pieces-channel')
        .on('postgres_changes', 
          { event: '*', schema: 'public', table: 'pieces' },
          (payload) => {
            isUpdatingFromServer = true;
            const piece = payload.new;
            updatePieceFromServer(piece.piece_index, piece);
            setTimeout(() => { isUpdatingFromServer = false; }, 100);
          }
        )
        .subscribe();

      // ========================================
      // INICIALIZACIÓN
      // ========================================

      async function init() {
        try {
          statusDot.className = 'status connecting';
          statusText.textContent = 'Conectando...';

          // Inicializar base de datos y obtener estado
          const state = await initializeDatabase();

          // Crear las piezas
          for (let i = 0; i < 4; i++) {
            createPiece(i, state[i]);
          }

          statusDot.className = 'status online';
          statusText.textContent = 'Todos pueden mover y rotar las piezas en tiempo real.';
        } catch (error) {
          console.error('Error de inicialización:', error);
          statusDot.className = 'status offline';
          statusText.textContent = 'Error de conexión';
        }
      }

      // ========================================
      // BOTÓN DE RESET
      // ========================================

      document.getElementById('btnReset').addEventListener('click', async () => {
        try {
          for (let i = 0; i < 4; i++) {
            const { error } = await supabase
              .from('pieces')
              .update({
                left: initialState[i].left,
                top: initialState[i].top,
                angle: initialState[i].angle
              })
              .eq('piece_index', i);

            if (error) throw error;
          }
        } catch (error) {
          console.error('Error reseteando:', error);
        }
      });

      // Iniciar la aplicación
      init();

    })();
  </script>
</body>
</html>
