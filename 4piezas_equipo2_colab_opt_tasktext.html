<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4 piezas â€” EQUIPO 2 (colaborativo Â· Reset)</title>
  <style>
    :root { --bg:#f7f8fb; --grid:rgba(0,0,0,.05); --piece:#c8e7ec; --stroke:#34424a; --shadow:rgba(0,0,0,.08); }
    html,body{margin:0;height:100%;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg)}
    .board{position:absolute;inset:0;background-image:linear-gradient(var(--grid) 1px,transparent 1px),linear-gradient(90deg,var(--grid) 1px,transparent 1px);background-size:40px 40px}
    .toolbar{position:fixed;top:10px;left:50%;transform:translateX(-50%);display:flex;gap:10px;align-items:center;background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:8px 12px;box-shadow:0 8px 20px rgba(0,0,0,.08);z-index:10}
    .pill{padding:6px 10px;border:1px solid #e6e6e6;border-radius:999px;background:#fff;cursor:pointer;user-select:none}
    .pill:hover{background:#f5f5f5}
    .presence{position:fixed;right:10px;top:10px;background:#fff;border:1px solid #e6e6e6;border-radius:12px;padding:6px 10px;font-size:12px;box-shadow:0 8px 20px rgba(0,0,0,.08);z-index:10}
    .task{position:fixed;left:40px;top:60px;background:rgba(255,255,255,.95);border:1px solid #e6e6e6;border-radius:12px;padding:10px 14px;max-width:620px;box-shadow:0 8px 20px rgba(0,0,0,.08);z-index:9; line-height:1.4}
    .piece{position:absolute;width:180px;height:120px;background:var(--piece);border:2px solid var(--stroke);border-radius:4px;box-shadow:0 6px 14px var(--shadow);transform-origin:center center;user-select:none;touch-action:none;will-change: transform;}
    .piece.selected{outline:2px solid rgba(0,0,0,.25)}
    .handle-rotate{position:absolute;left:50%;top:-22px;transform:translateX(-50%);width:16px;height:16px;border-radius:999px;background:#fff;border:2px solid #111;cursor:grab;display:none}
    .piece.selected .handle-rotate{display:block}
    .warn{position:fixed;right:10px;bottom:10px;background:#fff8e1;border:1px solid #e6c200;border-radius:10px;padding:8px 10px;font-size:12px;max-width:420px;box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .hint{font-size:12px;color:#666;margin-left:8px}
    .banner{position:absolute;left:24px;bottom:24px; z-index:5;background:#111; color:#fff; padding:10px 16px; border-radius:10px; box-shadow:0 8px 20px rgba(0,0,0,.12);font-weight:700; letter-spacing:.5px; font-size:18px; opacity:.92; pointer-events:none; user-select:none;}
  </style>
</head>
<body>
  <div class="toolbar">
    <div class="pill" id="btn-reset">Reset ejercicio</div>
    <span class="hint">Sala: <span id="room"></span> Â· Modo: <span id="mode">cargandoâ€¦</span></span>
  </div>
  <div class="presence">ðŸ‘¥ <span id="peers">â€”</span></div>
  <div class="task">
    <strong>Tenemos 4 piezas</strong>. Las puedes mover con el ratÃ³n. TambiÃ©n las puedes rotar pinchando en el pequeÃ±o circulito adyacente.
  </div>
  <div id="board" class="board">
    <div class="banner">EQUIPO 2</div>
  </div>
  <div id="warn" class="warn" style="display:none"></div>

  <script>
  function qs(sel, root){ return (root||document).querySelector(sel); }
  function qsa(sel, root){ return Array.prototype.slice.call((root||document).querySelectorAll(sel)); }

  var DEFAULT_ROOM="equipo2";
  var ROOM = new URLSearchParams(location.search).get("room") || DEFAULT_ROOM;
  qs("#room").textContent = ROOM;

  var board = qs("#board"), warn = qs("#warn");
  var state = new Map(); // id -> {el}
  var map, meta, provider;

  function showWarn(msg){ warn.style.display="block"; warn.innerHTML = msg; }

  // Load libs
  function loadScriptList(list){
    var i=0; return new Promise(function(resolve){ (function next(){ if(i>=list.length) return resolve(false); var s=document.createElement("script"); s.src=list[i++]; s.async=true; s.onload=function(){ resolve(true); }; s.onerror=next; document.head.appendChild(s);} )(); });
  }
  function ensureLibs(){
    var yOk=!!window.Y, wsOk=!!window.ywebsocket, p=Promise.resolve(true);
    if(!yOk){ p=loadScriptList(["https://unpkg.com/yjs@13.6.18/dist/yjs.js","https://cdn.jsdelivr.net/npm/yjs@13.6.18/dist/yjs.js"]); }
    return p.then(function(ok1){ var okY=yOk||ok1; if(!okY) return false; if(wsOk) return true; return loadScriptList(["https://unpkg.com/y-websocket@1.5.4/dist/y-websocket.js","https://cdn.jsdelivr.net/npm/y-websocket@1.5.4/dist/y-websocket.js"]); });
  }

  function apply(el,d){ el.style.transform='translate('+d.x+'px,'+d.y+'px) rotate('+(d.rot||0)+'deg)'; el.style.zIndex=d.z||1; }
  function makeEl(id){ var el=document.createElement("div"); el.className="piece"; el.dataset.id=id; var h=document.createElement("div"); h.className="handle-rotate"; el.appendChild(h); board.appendChild(el); attach(el,h); return el; }

  // Optimistic local updates + RAF-throttled Yjs writes
  var pending = Object.create(null), rafId=null;
  function scheduleSync(id, d){
    pending[id]=d;
    if(rafId) return;
    rafId = requestAnimationFrame(function(){
      var keys = Object.keys(pending);
      keys.forEach(function(k){ if(map.set) map.set(k, pending[k]); else map[k]=pending[k]; });
      pending = Object.create(null);
      rafId = null;
    });
  }

  function renderChanged(keys){
    keys.forEach(function(id){
      var d = map.get ? map.get(id) : map[id];
      if(!d) return;
      var entry = state.get(id);
      if(!entry){ var el=makeEl(id); entry={el:el}; state.set(id, entry); }
      apply(entry.el, d);
    });
  }

  function attachObservers(){
    if(map && map.observe){
      map.observe(function(event){
        var changed = [];
        if(event && event.keysChanged){ event.keysChanged.forEach(function(k){ changed.push(k); }); }
        else { var ids = map.keys ? Array.from(map.keys()) : Object.keys(map); changed = ids; }
        renderChanged(changed);
      });
    }
  }

  function select(id){ qsa(".piece").forEach(function(e){ e.classList.toggle("selected", e.dataset.id===id); }); window.selId=id; }
  function bringToFront(id){
    var cur = meta.get ? (meta.get("zmax")||1) : (meta.zmax||1);
    var next = cur + 1;
    if(meta.set) meta.set("zmax", next); else meta.zmax = next;
    var d = map.get ? Object.assign({}, map.get(id), {z:next}) : Object.assign({}, map[id], {z:next});
    scheduleSync(id, d);
    apply(state.get(id).el, d);
  }

  function attach(el,handle){
    var id = el.dataset.id;
    el.addEventListener("pointerdown", function(e){ if(e.button!==0) return; select(id); bringToFront(id); });
    var drag=false, start=null, orig=null;
    el.addEventListener("pointerdown", function(e){
      if(e.button!==0 || e.target===handle) return;
      drag=true; start={x:e.clientX,y:e.clientY};
      orig = map.get? Object.assign({}, map.get(id)) : Object.assign({}, map[id]);
      el.setPointerCapture(e.pointerId);
    });
    window.addEventListener("pointermove", function(e){
      if(!drag) return;
      var dx=e.clientX-start.x, dy=e.clientY-start.y;
      var d = Object.assign({}, orig, {x:orig.x+dx, y:orig.y+dy});
      apply(el, d);
      scheduleSync(id, d);
    });
    window.addEventListener("pointerup", function(){ drag=false; });

    var rot=false, a0=0, origR=null;
    handle.addEventListener("pointerdown", function(e){
      if(e.button!==0) return;
      rot=true; origR = map.get? Object.assign({}, map.get(id)) : Object.assign({}, map[id]);
      var r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
      a0=Math.atan2(e.clientY-cy, e.clientX-cx);
      el.setPointerCapture(e.pointerId); e.stopPropagation();
    });
    window.addEventListener("pointermove", function(e){
      if(!rot) return;
      var r=el.getBoundingClientRect(), cx=r.left+r.width/2, cy=r.top+r.height/2;
      var a=Math.atan2(e.clientY-cy, e.clientX-cx);
      var deg=(origR.rot||0)+((a-a0)*180/Math.PI);
      var d = Object.assign({}, origR, {rot:deg});
      apply(el, d);
      scheduleSync(id, d);
    });
    window.addEventListener("pointerup", function(){ rot=false; });
  }

  function seed(){
    var exists = map.size ? map.size>0 : Object.keys(map).length>0;
    if(exists) return;
    var y = window.innerHeight/2 - 60;
    var xs=[120, 340, 560, 780];
    xs.forEach(function(x,i){
      var id="p"+i; var d={x:x, y:y, rot:0, z:i+1};
      if(map.set) map.set(id, d); else map[id]=d;
      var el = makeEl(id); state.set(id, {el:el}); apply(el, d);
    });
    if(meta.set) meta.set("zmax", xs.length); else meta.zmax = xs.length;
  }
  function reset(){
    if(map.clear) map.clear(); else { Object.keys(map).forEach(function(k){ delete map[k]; }); }
    qsa(".piece").forEach(function(el){ el.remove(); });
    state.clear();
    seed();
  }

  function start(){
    ensureLibs().then(function(ok){
      if(!ok){
        qs("#mode").textContent="local (sin librerÃ­as)"; qs("#peers").textContent="1";
        showWarn("No se pudieron cargar yjs/y-websocket. Para colaboraciÃ³n, permite unpkg.com/jsDelivr y WebSockets a wss://demos.yjs.dev.");
        map={}; meta={zmax:1}; seed(); return;
      }
      var doc = new Y.Doc();
      provider = new ywebsocket.WebsocketProvider("wss://demos.yjs.dev", ROOM, doc);
      map = doc.getMap("rects"); meta = doc.getMap("meta");
      qs("#mode").textContent="colaborativo";
      provider.awareness.on("update", function(){ qs("#peers").textContent = String(provider.awareness.getStates().size); });
      attachObservers();
      seed();
    });
  }

  qs("#btn-reset").addEventListener("click", reset);
  board.addEventListener("pointerdown", function(e){ if(e.target===board){ window.selId=null; qsa(".piece").forEach(function(el){ el.classList.remove("selected"); }); } });

  start();
  </script>
</body>
</html>
